{% extends "bootstrap/base.html" %} {% block title %} {{ TITLE }} {% endblock %}
{% block styles %} {{ super() }}
<head>
 <meta charset="utf-8"/>
 <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
 <title>
  Object Detection in Panoramic Images
 </title>
 <link href="static/css/pannellum.css" rel="stylesheet"/>
 <script src="static/js/libpannellum.js" type="text/javascript">
 </script>
 <script src="static/js/pannellum.js" type="text/javascript">
 </script>
 <script src="static/js/script.js" type="text/javascript">
 </script>

 <style>
  #panorama {
            width: 800px;
            height: 400px;
        }
 </style>
</head>
<p>
<h1 align="center">
 Riconoscimento di oggetti in immagini panoramiche per la sicurezza dell'ambiente
</h1>
</p>
<div class="container">
 <div class="row">
  <h2>
   Seleziona un file da caricare
  </h2>
  <p>
   {% with messages = get_flashed_messages() %}
   {% if messages %}
  <ul>
   {% for message in messages %}
   <li>
    {{ message }}
   </li>
   {% endfor %}
  </ul>
  {% endif %}
  {% endwith %}
  </p>
  {% if filename %}
  {% endif %}
  <form action="/" enctype="multipart/form-data" method="post">
   <dl>
    <p>
     <input autocomplete="off" class="form-control" name="file" required="" type="file"/>
    </p>
   </dl>
   <p>
    <input class="btn btn-info" type="submit" value="Carica"/>
   </p>
  </form>
  <div id="panorama">
  </div>

  <!-- <div style="position: relative; top: 50%; transform: translateY(-50%);">
   <div style="max-width: 800px; max-height: 400px; margin: 0 auto;">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 150">
     <path fill="#aaa"
           d="m0 0v150l4.457-0.91797s68.671-14.113 145.54-14.113c76.872 0 145.54 14.113 145.54 14.113l4.46 0.92v-150l-4.457 0.91602s-68.671 14.113-145.54 14.113c-76.872 0-145.54-14.113-145.54-14.113zm7.4199 9.0098c11.163 2.1752 72 13.439 142.58 13.439s131.42-11.265 142.58-13.439v131.98c-11.16-2.17-72-13.44-142.58-13.44s-131.42 11.267-142.58 13.441zm159.82 63.144c-0.28454-0.51166-0.64312-0.99171-1.0333-1.4485-2.119-2.5791-5.2905-4.2747-8.8638-4.2747-3.585 0-6.7564 1.6856-8.8754 4.253-0.38936 0.4684-0.74877 0.94844-1.0541 1.4701-1.0633 1.7696-1.7072 3.8146-1.7072 6.0318 0 6.4794 5.2081 11.742 11.637 11.742 6.397 0 11.606-5.263 11.606-11.742-0.00083-2.2164-0.63313-4.2613-1.7089-6.0318m6.6083-1.5017c1.0341 2.3021 1.6448 4.8362 1.6448 7.5335 0 10.133-8.1283 18.359-18.15 18.359-10.035 0-18.161-8.2265-18.161-18.359 0-2.6972 0.60151-5.2314 1.644-7.5451h-32.43v27.665c0 3.7497 3.0017 6.8088 6.7356 6.8088h69.682c3.7222 0 6.7564-3.0592 6.7564-6.8088l0.0225-27.653zm-20.41-20.896h-7.1042v-3.4743h7.1042zm6.5126-4.8703h-20.059l-4.1324 6.1166h27.975zm21.819 2.5891h-8.254l-1.4643 3.4843h11.057zm-55.896 1.2047h-6.199l-0.71633 2.2588h7.4303zm31.463 11.147c6.6183 0 12.365 3.6449 15.537 9.0135l18.699 0.02163v-10.135c0-3.7713-3.0342-6.8305-6.7564-6.8305h-69.683c-3.7339 0-6.7356 3.0591-6.7356 6.8305l0.0191 10.049 33.372 0.02246c3.1948-5.3496 8.9179-8.9719 15.548-8.9719"/>
    </svg>
   </div>
   <p class="text-center" style="color: #aaa; font-size: 30px;"><strong>Preview
    will appear here.</strong></p>
  </div> -->

  <script>

   //funzione per verificare che il file esista
   function doesFileExist(urlToFile) {
                var xhr = new XMLHttpRequest();
                xhr.open('HEAD', urlToFile, false);
                xhr.send();

                if (xhr.status == "404") {
                    return false;
                } else {
                    return true;
                }
   }


   img = "{{ url_for('display_image', filename=filename) }}"

   //se non Ã¨ presente un immagine caricata dall'utente, non viene visualizzato il motore grafico Pannellum
   if(img == "/display/"){
      document.getElementById("panorama").display = none;
   }

   //se il risultato del riconoscimento non esiste visualizzo l'immagine caricata, altrimenti mostro il risultato
   if(!doesFileExist("static/output/output.jpg")){
    pannellum.viewer('panorama', {
                "type": "equirectangular",
                "panorama": "{{ url_for('display_image', filename=filename) }}",
                "autoLoad": true,
                "showZoomCtrl": true,
                "showFullscreenCtrl": true,
                "dynamicUpdate": true
            });
   }else{
    pannellum.viewer('panorama', {
                "type": "equirectangular",
                "panorama": "static/output/output.jpg",
                "autoLoad": true,
                "showZoomCtrl": true,
                "showFullscreenCtrl": true
            });
   }

  </script>

  <br/>
  <form id="control">
   Esegui modello di riconoscimento:
   <a id="use-model">
    <button class="btn btn-default" id="detect">
     Esegui
    </button>
   </a>
   <br/>
   <br/>
  </form>
 </div>

 <div><span id="testo-da-python"></span></div>

 <div id="elapsedTime" style="display: none;">Tempo di esecuzione: <span id="time"></span> secondi</div>
 <button id="reloadButton" style="display: none;">Mostra risultato</button>

 <script>
  var startTime;
  var elapsedTimeElement = document.getElementById('elapsedTime');
  elapsedTimeElement.style.display = 'none';

  //funzione per far trascorrere il tempo di esecuzione
  function updateElapsedTime() {
      var currentTime = Date.now();
      var elapsedTime = Math.round((currentTime - startTime) / 1000);
      document.getElementById('time').textContent = elapsedTime;
  }

  //gestione pulsante detect
  document.getElementById('detect').addEventListener('click', function() {
      startTime = Date.now();
      elapsedTimeElement.style.display = 'block';
      checkFileExists('static/output/output.jpg');
  });

  //se il risultato del riconoscimento esiste
  function checkFileExists(filePath) {
      fetch(filePath)
      .then(response => {
          if (response.ok) {
              // Il file esiste, mostra il pulsante per ricaricare la pagina e nasconde il tempo trascorso
              document.getElementById('reloadButton').style.display = 'block';

              // Effettuo una richiesta AJAX per ottenere il numero di oggetti riconosciuti
              fetch('/oggettiRiconosciuti')
              .then(response => response.json())
              .then(data => {
                  // Aggiorna il testo sulla pagina HTML col numero di oggetti riconosciuti
                  document.getElementById('testo-da-python').textContent = data.stringa;
              });
          } else {
              // Il file non esiste ancora, mostra il tempo trascorso e continua a controllare ogni secondo
              updateElapsedTime();
              setTimeout(checkFileExists, 1000, filePath);
          }
      })
      .catch(error => {
          console.error('Errore durante il controllo dell\'esistenza del file:', error);
      });
  }

  //pulsante "mostra risultato", viene ricaricata la pagina per mostrare il risultato
  document.getElementById('reloadButton').addEventListener('click', function() {
      location.reload();
  });

  //quando viene ricaricata la pagina vengono gestiti alcuni elementi
  document.addEventListener('DOMContentLoaded', function() {
      startTime = Date.now();
      elapsedTimeElement.style.display = 'none';
      checkFileExists('static/output/output.jpg');
  });
 </script>


</div>
{% endblock %} {% block scripts %}
<!-- Imports -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js">
</script>
<!-- Scripts -->
<script src="{{ url_for('static', filename='js/script.js') }}" type="text/javascript">
</script>
{{ super() }} {% endblock %}
